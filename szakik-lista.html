<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Szakember v√°laszt√°s ‚Äì SzakiChat</title>

<style>
    body { font-family:Arial; background:#f2f2f2; margin:0; }
    header {
        background:#007aff; color:white; text-align:center;
        padding:16px; font-size:22px; font-weight:bold;
    }
    .box {
        max-width:480px; margin:20px auto; background:white;
        padding:18px; border-radius:12px;
        box-shadow:0 3px 12px rgba(0,0,0,0.15);
    }
    .szaki {
        padding:14px; border:1px solid #ddd; border-radius:10px;
        margin:10px 0; background:#fafafa; position:relative;
    }
    .btn {
        margin-top:10px; width:100%; background:#007aff; color:white;
        padding:10px; border:none; border-radius:8px; cursor:pointer;
    }
    .btn:disabled { background:#ccc; cursor:not-allowed; }
    .online { color:green; font-weight:bold; }
    .small { font-size:14px; color:#666; margin-top:4px; }
    
    /* X gomb */
    .removeBtn {
        position:absolute;
        right:10px;
        top:10px;
        background:#ff3b30;
        color:white;
        border:none;
        border-radius:50%;
        width:26px;
        height:26px;
        cursor:pointer;
        font-weight:bold;
    }
</style>
</head>

<body>

<header>V√°lassz maximum 3 szakembert</header>

<div class="box" id="welcome"></div>

<div class="box">
    <h3>El√©rhet≈ë szakemberek Budapesten:</h3>
    <div id="szakiList">Bet√∂lt√©s‚Ä¶</div>
</div>

<script type="module">
import { db } from "./firebase.js";
import {
    collection, query, where, getDocs, doc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// Megrendel≈ë neve
const userName = localStorage.getItem("user_name") || "Ismeretlen felhaszn√°l√≥";
const userID = localStorage.getItem("user_id") || ""; // k√©s≈ëbb az Auth adja

document.getElementById("welcome").innerHTML = `
    <b>${userName}</b><br>
    Jelenleg <b>maximum 3 szakival</b> besz√©lhetsz egyszerre.
`;

// T√°rolt kiv√°lasztott szakik
let selected = JSON.parse(localStorage.getItem("selected_szakik") || "[]");

// X-gombbal t√∂r√∂lhet≈ë szakik
let blocked = JSON.parse(localStorage.getItem("blocked_szakik") || "[]");

// --- SZAKIK BET√ñLT√âSE FIRESTORE-B√ìL ---
async function loadSzakik() {
    const listBox = document.getElementById("szakiList");
    listBox.innerHTML = "Bet√∂lt√©s‚Ä¶";

    const q = query(
        collection(db, "users"),
        where("role", "==", "szaki"),
        where("city", "==", "Budapest")
    );

    const snap = await getDocs(q);
    listBox.innerHTML = "";

    snap.forEach(docu => {
        const s = docu.data();
        const id = docu.id;
        const online = s.online ? "üü¢ Online" : "‚ö™ Offline";

        const alreadySelected = selected.includes(id);
        const alreadyBlocked = blocked.includes(id);

        const disabled =
            (selected.length >= 3 && !alreadySelected)
            || alreadyBlocked
            ? "disabled"
            : "";

        listBox.innerHTML += `
            <div class="szaki">
                
                ${alreadySelected
                    ? `<button class="removeBtn" onclick="removeSzaki('${id}')">X</button>`
                    : ""
                }

                <b>${s.name}</b> ‚Äî ${s.profession}<br>
                <span class="small">${online}</span><br><br>

                <button class="btn" ${disabled}
                    onclick="selectSzaki('${id}', '${s.name}')">
                    ${alreadySelected ? "M√°r kiv√°lasztottad" : "Chat ind√≠t√°sa"}
                </button>
            </div>
        `;
    });
}

loadSzakik();

// --- SZAKI KIV√ÅLASZT√ÅSA ---
window.selectSzaki = function(id, name) {
    if (!selected.includes(id)) {
        selected.push(id);

        // 3-n√°l t√∂bb ne lehessen
        if (selected.length > 3) selected.length = 3;

        localStorage.setItem("selected_szakik", JSON.stringify(selected));
    }

    // bel√©p chatbe
    localStorage.setItem("chat_with", id);
    localStorage.setItem("chat_with_name", name);

    window.location.href = "user-chat.html";
};

// --- SZAKI X-EL√âSE ---
window.removeSzaki = async function(id) {
    // 1. Kiveszi a list√°b√≥l
    selected = selected.filter(x => x !== id);
    localStorage.setItem("selected_szakik", JSON.stringify(selected));

    // 2. Hozz√°adjuk tiltott list√°hoz
    if (!blocked.includes(id)) {
        blocked.push(id);
        localStorage.setItem("blocked_szakik", JSON.stringify(blocked));
    }

    // 3. FIRESTORE: a szakival nem besz√©lhet tov√°bb, automatikus √ºzenet
    const chatID = userID + "_" + id;

    try {
        await updateDoc(doc(db, "chats", chatID), {
            blocked: true,
            systemMessage:
                "A megrendel≈ë lez√°rta a besz√©lget√©st. M√°s szakikat is meghallgat, 24 √≥r√°n bel√ºl d√∂nt."
        });
    } catch (e) {
        console.log("Chat m√©g nem l√©tezett, nem gond.");
    }

    loadSzakik();
};
</script>

</body>
</html>
