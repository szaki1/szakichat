<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Elérhető szakik – SzakiChat</title>

<style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; }
    header {
        background:#007aff; color:white; text-align:center;
        padding:18px; font-size:22px; font-weight:bold;
    }
    .box {
        background:white; max-width:480px; margin:20px auto;
        padding:18px; border-radius:12px;
        box-shadow:0 4px 14px rgba(0,0,0,0.1);
    }
    .szaki {
        border:1px solid #ddd; border-radius:10px;
        padding:12px; margin:10px 0; background:#fafafa;
    }
    .btn {
        background:#007aff; color:white; border:none;
        padding:10px; border-radius:8px; cursor:pointer;
        margin-top:10px; width:100%;
    }
    .btn:disabled {
        background:#ccc; cursor:not-allowed;
    }
    .small { font-size:14px; color:#555; }
    .online { color:green; font-weight:bold; }
</style>
</head>

<body>

<header>Elérhető szakik</header>

<div class="box" id="welcomeBox"></div>

<div class="box">
    <h3>Budapesti szakik:</h3>
    <div id="szakiList"></div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
    getFirestore, collection, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import {
    getAuth, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
    apiKey: "AIzaSyAKhHvi3yObUurBKhT1r_feg4g0A5w766Q",
    authDomain: "szaki-app.firebaseapp.com",
    projectId: "szaki-app",
    storageBucket: "szaki-app.firebasestorage.app",
    messagingSenderId: "418149364598",
    appId: "1:418149364598:web:2ae4450dc8fadfbac30057"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ➜ Megrendelő UID
let customerUID = null;

// ➜ Max 3 chat
let activeChats = 0;

// ➜ Üdvözlő szöveg
function renderWelcome() {
    const userName = localStorage.getItem("user_name") || "Megrendelő";
    document.getElementById("welcomeBox").innerHTML =
        `<b>${userName}</b><br><br>
         Válassz ki maximum <b>3 szakembert</b>, akikkel szeretnél beszélni.`;
}

// ➜ Szakik betöltése Firestore-ból
async function loadSzakik() {
    const szakiBox = document.getElementById("szakiList");
    szakiBox.innerHTML = "Betöltés...";

    const colRef = collection(db, "szakik");
    const snapshot = await getDocs(colRef);

    szakiBox.innerHTML = "";

    snapshot.forEach(doc => {
        const s = doc.data();
        const szakiUID = doc.id;

        const isFull = activeChats >= 3;

        szakiBox.innerHTML += `
            <div class="szaki">
                <b>${s.name}</b> — ${s.profession}<br>
                <span class="small">Város: ${s.city}</span><br>
                <span class="small ${s.online ? "online" : ""}">
                    ${s.online ? "Online" : "Offline"}
                </span><br><br>

                <button class="btn" 
                    ${isFull ? "disabled" : ""}
                    onclick="startChat('${szakiUID}')">
                    Chat indítása
                </button>
            </div>
        `;
    });
}

// ➜ Chat indítása
window.startChat = function (szakiUID) {
    if (!customerUID) {
        alert("Hiba: nincs bejelentkezett felhasználó!");
        return;
    }

    if (activeChats >= 3) return;

    activeChats++;

    // Valódi URL paraméterek:
    const chatURL =
        `user-chat.html?customer=${customerUID}&szaki=${szakiUID}`;

    window.location.href = chatURL;
};

// ➜ Ellenőrizzük a bejelentkezést
onAuthStateChanged(auth, user => {
    if (!user) {
        window.location.href = "index.html";
        return;
    }

    customerUID = user.uid;

    renderWelcome();
    loadSzakik();
});
</script>

</body>
</html>
