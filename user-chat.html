<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SzakiChat ‚Äì Chat</title>

<style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; }
    header {
        background:#007aff; color:white; text-align:center;
        padding:16px; font-size:22px; font-weight:bold;
    }

    #chatBox {
        max-width: 480px;
        margin: 20px auto;
        background:white;
        border-radius:12px;
        padding: 15px;
        box-shadow:0 4px 14px rgba(0,0,0,0.1);
        height: 70vh;
        overflow-y: auto;
    }

    .msg {
        padding:10px 14px;
        border-radius:10px;
        margin:6px 0;
        max-width: 80%;
        word-break: break-word;
    }

    .me { background:#007aff; color:white; margin-left:auto; }
    .them { background:#e5e5ea; color:black; margin-right:auto; }

    #inputArea {
        display:flex;
        gap:6px;
        max-width:480px;
        margin: 12px auto;
    }

    input {
        flex:1;
        padding:12px;
        border-radius:8px;
        border:1px solid #ccc;
    }

    button {
        background:#007aff;
        color:white;
        border:none;
        padding:12px;
        border-radius:8px;
        cursor:pointer;
    }

    #adSpace {
        max-width:480px; margin:10px auto;
        padding:12px; background:#fff3cd; text-align:center;
        border:1px solid #ffeeba; border-radius:8px;
        font-size:14px;
    }

    #photoInput { display:none; }
</style>
</head>

<body>

<header>SzakiChat ‚Äì Chat</header>

<div id="chatBox">Bet√∂lt√©s‚Ä¶</div>

<div id="inputArea">
    <input id="msgInput" placeholder="√çrj √ºzenetet‚Ä¶">
    <button onclick="sendMsg()">K√ºld√©s</button>
    <button onclick="document.getElementById('photoInput').click()">üì∑</button>
    <button onclick="startVoice()">üé§</button>
</div>

<input type="file" id="photoInput" accept="image/*">

<div id="adSpace">‚≠ê Rekl√°m hely ‚Äì Google Ads vagy c√©ges banner ide ker√ºl ‚≠ê</div>

<script type="module">

/* ================================
   FIREBASE IMPORT
================================ */
import {
    initializeApp
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
    getFirestore, collection, addDoc, query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

import {
    getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";


/* ================================
   FIREBASE KONFIG
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyAKhHvi3yObUurBKhT1r_feg4g0A5w766Q",
  authDomain: "szaki-app.firebaseapp.com",
  projectId: "szaki-app",
  storageBucket: "szaki-app.firebasestorage.app",
  messagingSenderId: "418149364598",
  appId: "1:418149364598:web:2ae4450dc8fadfbac30057"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);


/* ================================
   CHAT AZONOS√çT√ì BET√ñLT√âSE
================================ */
const chatWith = localStorage.getItem("chat_with");
const userName = localStorage.getItem("user_name") || "Megrendel≈ë";

if (!chatWith) {
    alert("Hi√°nyz√≥ chat azonos√≠t√≥.");
}


/* ================================
   FIRESTORE CSATORNA
================================ */
const chatRef = collection(db, "chats", chatWith, "messages");

const q = query(chatRef, orderBy("time", "asc"));

onSnapshot(q, (snapshot) => {
    const box = document.getElementById("chatBox");
    box.innerHTML = "";

    snapshot.forEach(doc => {
        const d = doc.data();

        let type = d.sender === userName ? "me" : "them";

        if (d.photoUrl) {
            box.innerHTML += `
                <div class="msg ${type}">
                    <img src="${d.photoUrl}" style="max-width:180px; border-radius:8px;">
                </div>
            `;
        } else {
            box.innerHTML += `
                <div class="msg ${type}">
                    ${d.text}
                </div>
            `;
        }
    });

    box.scrollTop = box.scrollHeight;
});


/* ================================
   √úZENET K√úLD√âS
================================ */
async function sendMsg() {
    const text = document.getElementById("msgInput").value.trim();

    if (!text) return;

    // TILT√ÅS: telefonsz√°m, email, FB n√©v stb.
    if (/(06|07|\+36|\@|facebook|messenger|gmail|viber|whatsapp)/i.test(text)) {
        alert("El√©rhet≈ës√©g k√ºld√©se z√°rolva! Minimum 5 megoszt√°s ut√°n enged√©lyezett.");
        return;
    }

    await addDoc(chatRef, {
        sender: userName,
        text,
        time: Date.now()
    });

    document.getElementById("msgInput").value = "";
}


/* ================================
   FOT√ìK√úLD√âS
================================ */
document.getElementById("photoInput").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const fileRef = ref(storage, `chat_photos/${chatWith}/${Date.now()}.jpg`);

    await uploadBytes(fileRef, file);
    const url = await getDownloadURL(fileRef);

    await addDoc(chatRef, {
        sender: userName,
        photoUrl: url,
        time: Date.now()
    });
});


/* ================================
   DIKT√ÅL√ÅS GOMB
================================ */
function startVoice() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
        alert("A b√∂ng√©sz≈ë nem t√°mogatja a besz√©dfelismer√©st.");
        return;
    }

    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = "hu-HU";

    rec.start();

    rec.onresult = (e) => {
        let text = e.results[0][0].transcript;
        document.getElementById("msgInput").value = text;
    };
}

</script>

</body>
</html>
