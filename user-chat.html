<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SzakiChat ‚Äì Chat</title>

<style>
    body { margin:0; background:#f2f2f2; font-family:Arial; }

    header {
        background:#007aff; color:white; text-align:center;
        padding:16px; font-size:22px; font-weight:bold;
    }

    #chatBox {
        max-width:480px; margin:20px auto;
        background:white; border-radius:12px;
        padding:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);
        height:70vh; display:flex; flex-direction:column;
    }

    #chatMessages {
        flex:1; overflow-y:auto; padding:10px;
        border-bottom:1px solid #ddd;
    }

    .bubble {
        padding:10px 14px;
        margin:6px 0;
        background:#e9e9e9;
        border-radius:12px;
        max-width:80%;
        font-size:15px;
    }

    .user { background:#007aff; color:white; margin-left:auto; }

    #inputArea {
        display:flex; gap:6px; margin-top:10px;
    }

    #msgInput {
        flex:1; padding:10px; border-radius:8px;
        border:1px solid #ccc; font-size:15px;
    }

    #sendBtn, #micBtn {
        padding:10px 16px; background:#007aff; color:white;
        border:none; border-radius:8px; cursor:pointer;
    }

    #imageBtn {
        display:none;
    }

    .adbox {
        margin:20px auto; max-width:480px;
        padding:10px; text-align:center;
        background:#ffe8b3; border-radius:10px;
        color:#5a4300; font-size:14px;
    }
</style>
</head>

<body>

<header>SzakiChat ‚Äì Chat</header>

<div id="chatBox">
    <div id="chatMessages">Bet√∂lt√©s‚Ä¶</div>

    <div id="inputArea">

        <input id="msgInput" placeholder="√çrj √ºzenetet...">

        <button id="micBtn">üé§</button>

        <button id="sendBtn">K√ºld√©s</button>

        <input type="file" id="imageBtn" accept="image/*">
    </div>

    <button onclick="document.getElementById('imageBtn').click()" 
            style="margin-top:10px; width:100%; padding:10px; border-radius:8px; border:none; background:#555; color:white;">
        üì∑ K√©p k√ºld√©se
    </button>
</div>

<div class="adbox">‚≠ê Rekl√°m hely ‚Äì Google Ads vagy c√©ges banner ide ker√ºl ‚≠ê</div>

<!-- FIREBASE CHAT SCRIPT -->
<script type="module">
import { db, storage } from "./firebase.js";
import {
  collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// --- Chat ID ellen≈ërz√©se ---
const chatId = localStorage.getItem("chat_with");
if (!chatId) {
    alert("Hi√°nyz√≥ chat azonos√≠t√≥.");
    window.location.href = "user-chat-list.html";
}

// --- DOM elemek ---
const messagesBox = document.getElementById("chatMessages");
const input = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const imgBtn = document.getElementById("imageBtn");
const micBtn = document.getElementById("micBtn");

// --- √úzenet k√ºld√©s ---
async function sendMessage(text) {
    if (!text.trim()) return;

    await addDoc(collection(db, "chats", chatId, "messages"), {
        sender: "user",
        type: "text",
        text: text,
        createdAt: serverTimestamp()
    });

    input.value = "";
}

sendBtn.onclick = () => sendMessage(input.value);

// --- K√âPK√úLD√âS ---
imgBtn.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const storageRef = ref(storage, `chatImages/${chatId}/${Date.now()}.jpg`);
    await uploadBytes(storageRef, file);

    const url = await getDownloadURL(storageRef);

    await addDoc(collection(db, "chats", chatId, "messages"), {
        sender: "user",
        type: "image",
        url: url,
        createdAt: serverTimestamp()
    });
};

// --- DIKT√ÅL√ÅS ---
micBtn.onclick = () => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        alert("A b√∂ng√©sz≈ëd nem t√°mogatja a hangfelismer√©st.");
        return;
    }

    const rec = new SpeechRecognition();
    rec.lang = "hu-HU";

    rec.onresult = (e) => {
        input.value = e.results[0][0].transcript;
    };

    rec.start();
};

// --- VAL√ìS IDEJ≈∞ CHAT FIRESTORE-B√ìL ---
const q = query(
    collection(db, "chats", chatId, "messages"),
    orderBy("createdAt", "asc")
);

onSnapshot(q, (snapshot) => {
    messagesBox.innerHTML = "";

    snapshot.forEach(doc => {
        const msg = doc.data();

        if (msg.type === "text") {
            messagesBox.innerHTML += `<div class="bubble user">${msg.text}</div>`;
        }

        if (msg.type === "image") {
            messagesBox.innerHTML += `
                <div class="bubble user">
                    <img src="${msg.url}" style="max-width:100%; border-radius:10px;">
                </div>`;
        }
    });

    messagesBox.scrollTop = messagesBox.scrollHeight;
});
</script>

</body>
</html>
